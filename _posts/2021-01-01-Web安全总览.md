---
layout: mypost
title: Web安全总览
categories: [Web安全]
---
Web是指一个网站的前端页面到后端服务，比如常见的Javascript、PHP、Python、Mysql、jQuery、Docker等，包括开发、运维这些服务。

Web安全就是从安全的角度探索Web的一种方式。

早期的互联网非常的单调，一般只有静态页面，现在随着技术的发展，Web上大多数站点实际上是Web应用程序，在服务器和浏览器之间进行双向的信息传递。

黑帽可利用网站操作系统的漏洞和Web服务程序的SQL注入漏洞等得到Web服务器的控制权限，轻则篡改网页内容，重则窃取重要内部数据，更为严重的则是在网页中植入恶意代码，使得网站访问者受到侵害。
# Web基础技术
## 1.前后端分离 
**前端：**页面表现、速度流畅、兼容性、用户体验等

**后端：**三高（高并发、高可用、高性能）、安全、储存、业务等

工具：最常用vscode，推荐atom、vim、sublime text		   
## 2.前端-HTML
***超文本标记语言 HyperText Markup language***
>架构-内容
——承载网站内容 HTML的标签和纯文本按规则的一个组成也就是我们常说的一个网页
——浏览器通过对HTML文档解析，根据标签的序，按指定标签的对应规则显示纯文本内容

### HTML网页结构
#### 版本声明

```html
<!DOCTYPE html> (不是HTML标签)
指示web浏览器关于页面使用哪个HTML版本进行编写的指令
```

#### 头部

```html
<head></head> 涉及页面标题、字符集、样式、链接等
<title> 页面标题必须存在
<base> 为所有链接指定默认地址
<link> 定义文档与外部资源的联系
<style> 定义样式信息
<script> 定义客户端脚本，比如JavaScript
<meta> 定义关于HTML文档的元数据，用于规定页面的描述、关键词、文档作者等
       搜索引擎会利用meta元素的name和content属性来索引页面
```

#### 主体

```html
<body></body>浏览器展现给用户的内容
包含标题、文本、段落、链接、图片、媒体等
所有的页面都由HTML主体部分标签来实现 
<p>hello</p> 标识一个段落
<a href= "url" >text</a> 标识一个链接文本
<ol><ul><li> 列表项相关
<table><tr><td> 表格项相关
<img> 标识一个图片信息
<b><i> 字体相关标签
<form><input> 表单相关标签
（标签之间可按照规则嵌套） 
```

### 标签/元素/属性
**标签：**HTML页面由标签和内容组成，标签一般成对出现

**元素：**HTML元素指的是从开始标签到结束标签的所有代码，包括开始结束标签

**属性：**属性一般描述于开始标签中，用于对元素提供附加信息   
## 3.前端-CSS
***层叠样式表 Cascading Style Sheets***
>装饰-布局
——是一种用来表现HTML（标准通用标记语言的一个应用）或XML（标准通用标记语言的一个子集）等文件样式的计算机语言
——能够对网页中元素位置的排版进行像素级精确控制，几乎支持所有的字体字号样式，拥有对网页对象和模型样式编辑的能力	   

## 4.前端-JavaScript
>动态-行为
——是可插入HTML页面、可以由绝大多数现代浏览器执行的轻量级编程语言
——基于原型编程，多范式的动态脚本语言，并且支持面向对象、命令式和声明式（如函数式编程）风格
——作为一种非常强大的脚本语言，由它引申出的XSS攻击，文件上传漏洞，常年占据Owasp Top10  

### 功能
1.做出反应（如弹窗）

2.改变HTML内容（如改变文字内容）

3.改变HTML样式

4.验证输入 （执行逻辑，也是安全问题来源）
### Node.js
简单的说，Node.js就是运行在服务端（后端）的JavaScript

是一个基于Chrome JavaScript运行时建立的一个平台 

是一个事件驱动I/O服务端JavaScript环境,基于Goole的V8引擎，V8引擎执行JavaScript的速度非常快，性能非常好	   
## 5.Web App 
即Web应用程序，运行于网络和标准浏览器上，基于网页技术开发实现特定功能的应用
### 涉及的技术栈
前端：HTML、CSS、JavaScript

后端：Java、Python、PHP

数据库：MySQL、Oracle、MongoDB

容器：Windows（IIS）、Linux（Nginx、Apache）

协议：TCP、DNS、HTTP、HTTPS 
### 网址到网页过程
1.客户输入URL，DNS解析URL得出IP地址，根据IP地址找到服务器

2.客户机通过TCP/IP协议（传输控制/网络协议，也叫网络通讯协议）建立到Web服务器的TCP链接

3.客户机向Web服务器发送HTTP请求报文，请求服务器里的资源文档

4.Web服务器接收到客户机的请求报文，向客户机发出HTTP响应报文

5.客户机解析HTML静态文件

6.客户机与服务器断开链接
>——如果请求的的是HTML文档，Web服务器会将对应目录下相应的HTML文件打开,然后将文档的内容发送给客户机
——如果请求的是PHP文件（超文本预处理器，是一种通用的开源脚本语言（动态文件的一种，还有如ASP、ASPX、JSP））,那么Web服务器自身是不能处理PHP的，就会寻找委派PHP应用服务器,PHP服务器会将Web服务器请求的PHP文件解析成HTML静态代码,然后将HTML静态代码发送给Web服务器最后Web服务器会将HTML静态代码发送给客户机			
——如果请求的资源是访问数据库，则Web服务器会通过PHP应用服务器去访问数据库	

### 常见的Web服务器
**Apache HTTP Server(Apache)：**是Apache软件基金会的一个开发源代码的网页服务器软件，可以在大多数电脑操作系统中运行由于其跨平台和安全性被广泛使用，是最流行的Web服务器软件之一	  

**Nginx：**是一款面向性能设计的HTTP服务器，它能反向代理HTTP,HTTPS,SMTP,POP3,IMAP 的协议链接,以及带有一个负责均衡器和HTTP缓存,相较于Apache、lighttpd具有占有内存小，稳定性高等优势	  

**IIS：**Internet Information Server，微软主推的服务器	

**Lighttpd：**是一个德国人领导的开源Web轻量级服务器软件,具有非常低的内存开销、CPU占用率低、效能好以及丰富的模块等特点		

**Tomcat：**是Apache软件基金会的Jakarta项目中的一个核心项目,由Apache、Sun和一些其他公司及个人共同开发而成,技术先进、性能稳定、而且免费,因而深受Java爱好者的喜爱并得到了部分软件开发商的认可,成为目前比较流行的Web应用服务器     

## 6.用python搭建服务器

```python
#!/usr/bin/python
# -*- coding: UTF-8 -*-

# 简单的服务器Demo
import socket
# 接收客户端发向服务器的请求，把文本内容用HTTP协议封装成一个包返回客户端
def handleRequests(client):
    buf = client.recv(2048)
    print(buf)
    msg = "HTTP/1.1 200 OK\r\n\r\n"
    msg1 = "hello world"
    client.send(('%s' % msg).encode())
    client.send(('%s' % msg1).encode())
# 监听本地8000端口
if __name__ == '__main__':
    ip_port = ('0.0.0.0', 8000)
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.bind(ip_port)
    sock.listen(5)
# 持续的接收来自客户端的输入并且进行返回
    while True:
        conn, addr = sock.accept()
        handleRequests(conn)
        conn.close()
```

运行：
![](https://pic.downk.cc/item/5fbedfbfedfc5a59426e7b78.png)

火狐浏览器包：

```code
GET / HTTP/1.1
Host: 127.0.0.1:8000
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:83.0) Gecko/20100101 Firefox/83.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
DNT: 1
Connection: keep-alive
Cookie: #略
Upgrade-Insecure-Requests: 1
```

## 7.Web App框架
***Web应用框架 Web application framework***
>一种开发框架
——用来支持动态网站、网络应用程序及网络服务的开发
——其类型有基于请求的和基于组件的两种框架
——有助于减轻网页开发时共通性活动的工负荷，例如许多框架提供数据库访问接口、标准样板以及会话管理等，可以提升代码的再用性

**前端流行：**jQuery、Bootstrap、React.js、Vue等

**后端流行：**Spring MVC、Django、Flask、Tornado等  

## 8.用Django搭建站点
>一个由python写成的开放源代码Web应用框架
——采用了MTV的框架模式，M(模型 model）T（模板 template）V(视图 view）
——最初被开发来用于管理劳伦斯出版社旗下的一些以新闻内容为主网站的，即是CMS(内容管理系统）软件，并于05年7月在BSD许可证下开源发布

### 安装
`python3 -m pip install django`

`django-admin startproject mysite`
>manage.py：Django用于管理本项目的命令行工具
_ init_.py 一个普通的包初始化模块
settings.py：Django项目配置文件
wsgi.py (Web Server gateway interface)：接口信息用于服务器部署

### 初运行
`python3 manage.py runserver 0.0.0.0:8000`

基于框架建立的项目：
![](https://pic.downk.cc/item/5fc0354615e77190844045f7.png)
（ctrl+c停止）
### 配置
**新建App：**`django-admin startapp firstapp`

**修改配置：**`vim mysite/settings.py`(注意import os)

*添加App索引：*

![](https://pic.downk.cc/item/5fc03b9715e771908440f5ee.png)

*提前添加前端页面文件索引：*

![](https://pic.downk.cc/item/5fc03cad15e771908441126e.png)

*允许外界IP访问：*

![](https://pic.downk.cc/item/5fc03e4d15e7719084413fb4.png)

**添加执行层代码：**`vim firstapp/views.py`(注意中文符号)

*添加能直接渲染并且返回自定义的静态文件函数：*

![](https://pic.downk.cc/item/5fc040b415e7719084418ab7.png)

**添加URL映射关系：**`vim mysite/urls.py`

*使用户URL访问地址链接到执行代码：*

![](https://pic.downk.cc/item/5fc0446f15e771908442490c.png)

**创建templates文件夹存放index.html：**`mkdir  templates`(主目录下）

**创建index.html：**`echo hello > templates/index.html`

运行如下：

![](https://pic.downk.cc/item/5fc04e6c15e771908443b50e.png)

**初始化数据库：**`python3 manage.py migrate`

**创建超级用户：**`python3 manage.py createsuperuser`

管理后台：
![](https://pic.downk.cc/item/5fc050ce15e77190844417d9.png)
![](https://pic.downk.cc/item/5fc0516815e77190844431be.png)

## Web安全基础
### HTTP协议
>定义了	Web客户端如何从Web服务器请求Web页面，以及服务器如何把Web页面传送给客户端

#### 客户端连接到Web服务器
HTTP客户端通常是浏览器，与Web服务器的HTTP端口（默认80）建立一个TCP**套接字**连接。

>套接字(Socket)
就是对网络中不同主机上的应用进程之间进行双向通信的端点的抽象

#### 发送HTTP请求
通过TCP套接字，客户端向Web服务器发送一个文本的请求报文。
>请求报文有四部分
1.请求行
2.请求头部
3.空行（CRLF）
4.请求数据 

##### GET vs POST
**从参数的传递方面来看**:GET请求的参数是直接拼接在地址栏URL的后面，而POST请求的参数是放到请求体里面的。

**从长度限制方面来看**:GET请求有具体的长度限制，一般不超过1024KB，而POST理论上没有，但是浏览器一般有个界限。

**从安全方面来看**:GET请求相较于POST，因为数据都是明文显示在URL上面的，所以安全和私密性不如POST

**从本质上来说，GET和POST都是TCP连接，并无实质的区别。**

但由于HTTP/浏览器的限定，导致它们在应用过程中体现出了一些不同。

GET产生一个数据包，浏览器会把http header 和data一并发出去，服务器响应200（返回数据）。

POST产生两个数据包，浏览器先发送header，服务器响应100 continue，浏览器再发送data，服务器响应200 ok。
##### 请求方法
![](http://standeblogtc.test.upcdn.net/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202020-11-29%20082330.png)
#### 服务器接受请求并返回HTTP响应
Web服务器解析请求，定位请求资源。服务器将资源复本写到TCP套接字，由客户端读取。
>响应也有四部分
1.状态行
2.响应头部
3.空行（请求空行）
4.响应数据（请求体）

##### 响应代码
![](http://standeblogtc.test.upcdn.net/XY1.png)
![](http://standeblogtc.test.upcdn.net/XY2.png)
![](http://standeblogtc.test.upcdn.net/3333.png)
![](http://standeblogtc.test.upcdn.net/XY3.png)
![](http://standeblogtc.test.upcdn.net/XY4.png)
#### 释放连接TCP连接
若connection模式为close，则服务器主动关闭TCP连接，客户端被动关闭连接，释放TCP连接。

若connection模式为keepalive，则该连接会保持一段时间，在该时间内可以继续接收请求。
#### 客户端浏览器解析HTML内容
### 安全溯源
Web App在实现HTTP协议过程中没有做足够强大的约束
![](http://standeblogtc.test.upcdn.net/web.png)
本质还是信任问题—**来源前端的输入不可信**
### 渗透工具
#### BurpSuite
![](http://standeblogtc.test.upcdn.net/BSS.png)
>用于攻击web 应用程序的集成平台，包含了许多工具。
Burp Suite为这些工具设计了许多接口，以加快攻击应用程序的过程。
所有工具都共享一个请求，并能处理对应的HTTP 消息、持久性、认证、代理、日志、警报。

![](http://standeblogtc.test.upcdn.net/BS.png)
#### cURL
![](http://standeblogtc.test.upcdn.net/curl.png)
 >一个功能强大灵活的网络工具，主要使用URL形式传输数据
 支持HTTPS,IMAP,POP3,RTSP,SCP,FTP,FTPS,TFTP,SMTP和SMB,Telnet等协议
 多用于抓取网页，执行网络请求，网络监控等方面，解决开发及调试中的问题

查看自己公网IP`curl ifconfig.co`

具体整个过程的HTTP协议体`curl -v ifconfig.co`
#### Postman
![](http://standeblogtc.test.upcdn.net/pm.png)
>可视化版本的Curl

#### Hackbar
![](http://standeblogtc.test.upcdn.net/hbq.png)
>Firefox浏览器插件
包含一些简单的工具（SQL injectio，XSS，加密等）
可以快速构建HTTP请求，快速实现某种算法等
多用于手工测试Web漏洞

#### Wappalyzer
![](http://standeblogtc.test.upcdn.net/WP.png)
>支持多种浏览器的插件
网站技术分析
了解目标网站采用的平台架构、网站环境、服务器配置环境、JavaScript框架以及编程语言等

### Docker
![](http://standeblogtc.test.upcdn.net/doc.png)
> 一个开源的应用容器引擎
让开发者可以打包他们的应用以及依赖包到一个可移植的镜像中，
然后发布到任何流行的 Linux或Windows 机器上，也可以实现虚拟化。
容器是完全使用沙箱机制，相互之间不会有任何接口。

配置一个漏洞容器
`docker pull registry.cn-shanghai.aliyuncs.com/yhskc/bwapp`

映射到本地80端口
`docker run -d -p  0.0.0.0:80:80 registry.cn-shanghai.aliyuncs.com/yhskc/bwapp`
（登陆http://127.0.0.1:80/install.php 配置本地账号）

PS:
Win10家庭版1909下面 VM虚拟机和Docker只能选其中一个......

如果设置为```bcdedit /set hypervisorlaunchtype off```虚拟机可以用，docker不能用。

如果设置为```bcdedit /set hypervisorlaunchtype auto```Docker可用，虚拟机无法使用。

设置完成后需要重启电脑生效。
>解释：
——老版本Vmware与一些Windows功能（例如Docker for Windows，WSL，Device Guard和Credential Guard）等基于Hyper-V / VBS（Virtualization Based Security）的服务不兼容。
具体原因如下：
 ——对于Vmware15.5.5之前的版本，其底层实现是基于VMM（Virtual Machine Monitor），VMM运行在特权模式下，需要直接访问CPU与CPU的硬件虚拟化支持（Intel的VT-x和AMD的AMD-V）。
——而当Windows主机开启VBS时，Windows在硬件和操作系统间添加了一个基于Hyper-V的虚拟化层。Hyper-V的存在会使VMM无法访问硬件的虚拟化支持，导致Vmware无法运行。
 ——即造成：docker需要Hyper-V，而开了Hyper-V无法使用Vmware。

>方案：
——为了解决Vmware与Hyper-V / Host VBS的兼容性问题，VMware基于Microsoft发布的WHP API重新设计了VMware的虚拟化技术。此后的VMM更改为在用户级别而不是特权模式下运行，使用WHP API管理用户的操作，而不是直接使用底层硬件。
——由此，Windows用户不再需要在运行VMware Workstation和基于Hyper-V的Windows功能（例如Docker for Windows，WSL，Device Guard和Credential Guard）之间进行选择。 启用Hyper-V后，将自动使用ULM模式，此后用户可以正常运行VMware Workstation。如果用户根本不使用Hyper-V，则VMware Workstation可以自动检测到，并将继续使用效率更高的VMM。

Windows10 专业版20H1 build 19041.264或以上，Vmware软件版本为15.5.5或以上完美运行

### Webshell
>即对于Web App的木马
以asp、php、jsp或者cgi等网页文件形式存在的一种代码执行环境，也可以将其称做为一种网页后门。

黑客在入侵了一个网站后，通常会将asp或php后门文件与网站服务器Web目录下正常的网页文件混在一起，然后就可以使用浏览器来访问asp或者php后门，得到一个命令执行环境，以达到控制网站服务器的目的。

“Web”的含义是显然需要服务器开放web服务，“shell”的含义是取得对服务器某种程度上操作权限。

Webshell常常被称为入侵者通过网站端口对网站服务器的某种程度上操作的权限。

由于Webshell其大多是以动态脚本的形式出现，也有人称之为网站的后门工具。

#### 关键eval函数(php为例)
![](http://standeblogtc.test.upcdn.net/eval.png)
#### 测试函数(php提供相应的API)
![](http://standeblogtc.test.upcdn.net/hanshu2.png)

![](http://standeblogtc.test.upcdn.net/hanshu1.png)

# Web漏洞
## 文件上传漏洞
>在开发者没有做充足验证（包括前端和后端）情况下，
允许用户上传恶意文件（木马、病毒、恶意脚本或者Webshell等）

### 一句话木马
![](http://standeblogtc.test.upcdn.net/yjhmm.png)
>原理：
通过取得POST里hacker字段里的一个参数（值）将其转换成php代码去执行。

把含有代码的shell.php上传到靶场里：

![](http://standeblogtc.test.upcdn.net/upupup.png)

![](http://standeblogtc.test.upcdn.net/shellup.png)

可以看到上传的文件没有被重命名和格式转换，可以直接执行代码。

但是这里回显为空，单纯的访问那个连接的通过的是GET请求，首先不是POST，其次也没有携带任何参数（值），所以目前的请求不执行任何代码。

所以要如何利用呢？

于是操纵网络协议的cURL~~粉墨登场~~派上用场啦

`curl -d "hacker=echo get_current_user();" http://127.0.0.1/images/shell.php`

通过POST发送hacker字段内容指定让Webshell回显当前的用户

![](http://standeblogtc.test.upcdn.net/wwwdata.png)

`curl -d "hacker=echo getcwd();" http://127.0.0.1/images/shell.php`

通过POST发送hacker字段内容指定让Webshell回显当前执行目录

![](http://standeblogtc.test.upcdn.net/1/getcwd.png)
#### 中国菜刀
>让Webshell一句话木马做不同功能的windows集成环境
测试环境用，实际已会被杀毒软件阻拦

### 绕过
#### 原理
把靶场里安全等级改为中等,会发现上传shell.php会被过滤,把后缀改为php3则可以上传并且和之前php效果一致,但如果改为php30则虽然可以上传但被会被解析为文本文件在上传成功页面回显内容,于是追查漏洞起因。

查看启用的docker:

![](http://standeblogtc.test.upcdn.net/3/11111.png)

在docker里打开bash命令:

![](http://standeblogtc.test.upcdn.net/3/3333.png)

查看网络服务:

![](http://standeblogtc.test.upcdn.net/3/44444.png)

打开apache配置目录:

![](http://standeblogtc.test.upcdn.net/3/555555.png)

查看总配置文件 apache2.conf找到解析配置目录:

![](http://standeblogtc.test.upcdn.net/3/66666.png)

打开解析配置目录:

![](http://standeblogtc.test.upcdn.net/3/777777.png)

查看php解析配置文件php5.conf找到解析规则:

![](http://standeblogtc.test.upcdn.net/3/88888.png)

得知具体的正则匹配规则 是php3/4/5和pht/phtml都会被解析为php文件。
